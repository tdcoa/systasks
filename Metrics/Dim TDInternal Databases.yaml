description: Print out table vt_dim_tdinternal_databases, for reconciliation purposes.
version: 1
tasks:

{% include "vt_dim_tdinternal_databases.j2" %}

- name: Export vt_dim_tdinternal_databases for reconciliation
  connect: source
  export:
    file: dim_tdinternal_databases_reconcile.csv
    sql: Select * from vt_dim_tdinternal_databases order by DatabaseName

- name: Create comparative summary of internal vs customer databases
  connect: source
  execute:
    sql: |
      create volatile table vt_tdinternaldb_summary as(
      select
       case when i.DatabaseName is not null then i.DatabaseName else 'Customer' end as DatabaseName
      ,case when i.DatabaseName is not null then i.DatabaseUse else 'Customer' end as DatabaseUse
      ,count(Exclude_VantageUnit_Flag) as Exclude_VantageUnit_Flag
      ,count(Exclude_QueryCount_Flag) as Exclude_QueryCount_Flag
      ,count(distinct d.DatabaseName) as DatabaseCount
      ,count(distinct t.DatabaseName||'.'||t.TableName) as ObjectCount
      from dbc.TablesV t
      join dbc.DatabasesV d
        on t.DatabaseName = d.DatabaseName
      left outer join vt_dim_tdinternal_databases i
        on i.DatabaseName = d.DatabaseName
      Group by 1,2
      ) with data no primary index on commit preserve rows


- name: Export full summary of internal vs customer databases
  connect: source
  export:
    file: dim_tdinternal_databases_summary.csv
    sql: Select * from vt_tdinternaldb_summary order by ObjectCount desc


- name: Export comparative aggregate of internal vs customer databases
  connect: source
  export:
    file: dim_tdinternal_databases_summary1.csv
    sql: |
      Select DatabaseName, ObjectCount as "Object Count"
      from vt_tdinternaldb_summary
      order by ObjectCount desc

- name: Chart TD internal database volume
  chart:
    command: chart/barline_xLabels_yBar_yLine.py
    params:
      - "file:dim_tdinternal_databases_summary1.csv"
      - "title:TD Internal Databases (Log Scale) - {{ siteid }}"
      - "height:6"
      - "width:18"
      - "legendy:1"
      - "xrotate:90"
      - "barlogscale:True"


- name: Export comparative aggregate of internal databases by use
  connect: source
  export:
    file: dim_tdinternal_databases_summary2.csv
    sql: |
      Select DatabaseUse as "Database Use"
      ,sum(DatabaseCount) as "Database Count"
      ,sum(ObjectCount) as "Object Count"
      from vt_tdinternaldb_summary
      where DatabaseName <> 'Customer'
      group by 1
      order by 2 desc

- name: Chart TD internal database volume
  chart:
    command: chart/barline_xLabels_yBar_yLine.py
    params:
      - "file:dim_tdinternal_databases_summary2.csv"
      - "title:TD Internal Databases by Use - {{ siteid }}"
      - "height:6"
      - "width:12"
      - "legendy:1"
      - "xrotate:90"
