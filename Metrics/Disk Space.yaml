description: "Export Disk Space by Table (vt_disk_space)"
version: 1
### ============= STANDARD PRE-PROCESSING =============
# SETUP run context, and skip duplicate CREATE vt_* statements :
{% set run = namespace(completed=[], dates=[]) if run is not defined else run %}
### import macro to harden start/end dates:
{% import "coa_util.j2" as macro with context %}
{{ macro.harden_dates(run, startdate, enddate) }}
{% set startdate = run.dates[0] %}
{% set enddate = run.dates[1] %}
### ============= STANDARD PRE-PROCESSING =============

tasks:

{% include "vt_disk_space.j2" %}


- name: "Export vt_disk_space summary for reconciliation (at 2M row/mth, default output is summary)"
  connect: source
  export:
    file: disk_space.csv
    sql: |
      Select * from vt_disk_space
      {% if all_dates %}
      -- display all dates
      {% else %}
      qualify LogDate = max(LogDate)over()
      {% endif %}
      Order by Table_System_Fill_Pct desc
