description: "Generate and export Feature Usage metrics, aggregated by date and by User"
version: 1
tasks:

{% set chart = true if chart is not defined else chart %}
{% set upload = false if upload is not defined else upload %}
{% set dev = false if dev is not defined else dev %}
{% set export_all = true if export_all is not defined else export_all %}

{% include "vt_feature_usage.j2" %}

# Let's just blast out the graphs via a loop:
{% if chart %}
{% set feature_columns = ['Feature_Category','Feature_SubCategory','Product_Name','Product_Category','Solution_Type','User_Experience_Level_Name','Initiator_Role_Category','Objective_Name','Department','UserType','Organization'] %}
{% for feature_column in feature_columns %}

- name: "Export for charting: {{ feature_column }}"
  connect: source
  export:
    file: feature_usage_x_{{ feature_column }}.csv
    sql: |
      select {{ feature_column }}
      ,sum(Request_Total_Cnt) as "Feature Count"
      ,sum(sum_parsercputime+sum_ampcputime)/nullifzero(sum(Request_Total_Cnt)) as "Average CPU Seconds"
      from vt_Feature_Usage
      group by 1
      order by 2 desc

- name: "Chart (linear): {{ feature_column }}"
  chart:
    command: chart/barline_xLabels_yBar_yLine.py
    params:
      - "file:feature_usage_x_{{ feature_column }}.csv"
      - "title:Feature Score by {{ feature_column }} - {{ siteid }}"
      - "height:5"
      - "width:9"
      - "xrotate:90"
      - "legendy:1.1"
      - "pngfile:feature_usage_x_{{ feature_column }}_linear.png"

- name: "Chart (log): {{ feature_column }}"
  chart:
    command: chart/barline_xLabels_yBar_yLine.py
    params:
      - "file:feature_usage_x_{{ feature_column }}.csv"
      - "title:Feature Score by {{ feature_column }} - {{ siteid }}"
      - "height:5"
      - "width:9"
      - "xrotate:90"
      - "legendy:1.1"
      - "pngfile:feature_usage_x_{{ feature_column }}_log.png"
      - "logscale:true"

{% endfor %}
{% endif %}



{% if export_all %}
- name: Export Full Detail of Feature Usage
  connect: source
  export:
    file: feature_usage_all.csv
    sql: |
      select * from vt_Feature_Usage as f
      order by LogDate, Request_Total_Cnt desc
{% endif %}
