description: "Runs DBQL_Core and upload results to Transcend, including both the existing COA table (adlste_coa.coa_dat_DBQL_Core) which covers existing PowerBI reporting, as well as the new COA table (adlste_coa.coa_dat_DBQL_Core2) which includes more request/statement breakouts for more nuanced querycount designs.  See the 'Help' article for more details. "
version: 1
# add this line to skip duplicate CREATE vt_* statements :
{% set run = namespace(completed=[]) if run is not defined else run %}


tasks:
{% set save_prework   = False %}
{% set include_hour   = True %}
{% set include_wdname = False %}
{% set include_user   = False %}
{% set reconcile      = True %}
{% include "vt_dbql_core.j2" %}

{% set upload = True if upload is not defined else upload %}
{% set stagedb = 'adlste_coa_stg' if stagedb is not defined else stagedb %}
{% set targetdb = 'adlste_coa' if targetdb is not defined else targetdb %}

{% if upload %}
- name: Export DBQL_Core.csv for upload to Transcend
  connect: source
  export:
    file: dbql_core_upload.csv
    sql: |
      Select
       Site_ID
      ,LogDate,LogTS,LogDate_Cnt
      ,Total_AMPs,Application,Application_Use,Application_Company
      ,Statement_Bucket,Statement_Outcome,UserType
      ,Organization,Department
      ,Exclude_Performance_Flag,Exclude_VantageUnit_Flag
      ,Request_Total_Cnt,Statement_Total_Cnt,Request_MultiStatement_Cnt
      ,Request_SubSecond_Cnt,Statement_SubSecond_Cnt
      ,Request_Tactical_Cnt,Statement_Tactical_Cnt
      ,Request_Error_Cnt,Statement_Error_Cnt
      ,Request_Spool_Error_Cnt,Statement_Spool_Error_Cnt
      ,Request_TASM_Abort_Cnt,Statement_TASM_Abort_Cnt
      ,Request_Abort_Cnt,Statement_Abort_Cnt
      ,Request_NoIO_Cnt,Statement_NoIO_Cnt
      ,Request_InMem_Cnt,Statement_InMem_Cnt
      ,Request_PhysIO_Cnt,Statement_PhysIO_Cnt
      ,Request_AllAMP_Cnt,Statement_AllAMP_Cnt
      ,Request_Utility_Cnt,Statement_Utility_Cnt
      ,DelayTime_Sec,RunTime_Parse_Sec,Runtime_AMP_Sec,RunTime_Total_Sec,TransferTime_Sec
      ,CPU_Parse_Sec,CPU_AMP_Sec
      ,IOCntM_Physical,IOCntM_Total,IOGB_Physical,IOGB_Total,IOTA_Used_cntB
      ,Spool_GB,Returned_Row_Cnt,NumOfActiveAMPs_Avg
      ,Query_Complexity_Score_Avg,CacheHit_Pct
      from vt_dbql_core
      Order by Site_ID, LogDate

- name: Import dbql_core_upload.csv into Transcend staging area
  connect: transcend
  import:
    file: dbql_core_upload.csv
    table: {{ stagedb }}.stg_dat_DBQL_Core2

- name: Merge staged data into the core layer
  connect: transcend
  call:
    proc: {{ targetdb }}.sp_dat_DBQL_Core2
    params:
    - Null

{% endif %}
