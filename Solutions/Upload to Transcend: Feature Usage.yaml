description: >
  Runs Feature Usage data from target system and upload results to Transcend.
  Once in Transcend, Feature data is merged with TCA data in the product table,
  thus flowing into all downstream reporting.  That production process runs 4 times
  daily, at 5am / 11am / 5pm / 11pm Pacific Time.  It additionally will generate
  several charts for immediate consumption.
version: 1

# add this line to skip duplicate CREATE vt_* statements :
{% set run = namespace(completed=[]) if run is not defined else run %}


tasks:
{% set save_prework   = False %}
{% set include_hour   = False %}
{% set include_wdname = False %}
{% set include_user   = False %}
{% set reconcile      = True %}
{% include "vt_dbql_core.j2" %}

{% set upload = True if upload is not defined else upload %}
{% set stagedb = 'adlste_coa_stg' if stagedb is not defined else stagedb %}
{% set targetdb = 'adlste_coa' if targetdb is not defined else targetdb %}

{% if upload %}
- name: Export DBQL_Core.csv for upload to Transcend
  connect: source
  export:
    file: dbql_core_upload.csv
    sql: |
      Select * from vt_dbql_core
      Order by Site_ID, LogDate

- name: Import dbql_core_upload.csv into Transcend staging area
  connect: transcend
  import:
    file: dbql_core_upload.csv
    table: {{ stagedb }}.stg_dat_DBQL_Core2

- name: Merge staged data into the core layer
  connect: transcend
  call:
    proc: {{ targetdb }}.sp_dat_DBQL_Core2
    params:
    - Null

{% endif %}
