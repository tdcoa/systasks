description: "Selects and Runs the GSSResUsage sizing SQL, and upload results to Transcend."
version: 1
### ============= STANDARD PRE-PROCESSING =============
# SETUP run context, and skip duplicate CREATE vt_* statements :
{% set run = namespace(completed=[], dates=[]) if run is not defined else run %}
### import macro to harden start/end dates:
{% import "coa_util.j2" as macro with context %}
{{ macro.harden_dates(run, startdate, enddate) }}
{% set startdate = run.dates[0] %}
{% set enddate = run.dates[1] %}
### ============= STANDARD PRE-PROCESSING =============

# set defalts:
{% set upload = True if upload is not defined else upload %}
{% set reconcile = True if reconcile is not defined else reconcile %}
{% set gtt_db        = 'APP_TCA_TMP' if gtt_db is not defined else gtt_db %}
{% set sp_db         = 'APP_TCA_TBL' if sp_db  is not defined else sp_db %}
{% set dbprefix      = '' %}

{% set tdv = tdver[:2] | int %}
{% set tdversion = tdver.replace('.','') %}
{% set pdcrstr = 'pdcr' if pdcr else 'dbc' %}

tasks:

{% if not skip_export %}
{% include "vt_gssresusage_core.j2" %}

- name: export final GSSResUsage_Core.csv file
  connect: source
  export:
    sql: Select * from vt_gssresusage_core order by logts
    file: gssresusage_core.csv
{% endif %}


- name: VALIDATE SITE_ID -- this procedure will ERROR if your Site_ID is not valid.  If you see an error here, VALIDATE/CORRECT THE SITE_ID AND RE-START THE JOB.
  connect: transcend
  call:
    proc: {{ dbprefix }}{{ sp_db }}.sp0_Validate_SiteID
    params:
     - '{{ siteid }}'

- name: Import Data from vt_gssresusage into the GTTable on Transcend
  connect: transcend
  import:
    file: gssresusage_core.csv
    table: {{ dbprefix }}{{ gtt_db }}.stg_gss_manual_upload

- name: Call StoredProc to merge data into final Transcend GSS Table
  connect: transcend
  call:
    proc: {{ dbprefix }}{{ sp_db }}.sp1_coa_gss_manual_upload
    params:
     - Null
